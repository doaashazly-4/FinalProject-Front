<!-- Failed Delivery Proof Modal -->
<div *ngIf="isVisible" class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/50" (click)="closeModal()"></div>

  <!-- Modal -->
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-primary-dark">فشل التسليم</h2>
        <button (click)="closeModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="bi bi-x text-gray-500 text-xl"></i>
        </button>
      </div>

      <!-- Reason Selection -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-800 mb-3">سبب الفشل</h3>
        <div class="space-y-2">
          <label *ngFor="let reason of reasons" class="flex items-center">
            <input type="radio"
                   [value]="reason.value"
                   [(ngModel)]="selectedReason"
                   class="ml-2">
            <span class="text-sm">{{ reason.label }}</span>
          </label>
        </div>
      </div>

      <!-- Photos Section -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-800 mb-3">التقاط الصور كدليل</h3>
        <div class="grid grid-cols-3 gap-3 mb-3">
          <div *ngFor="let preview of photoPreviews; let i = index"
               class="relative aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-red-300">
            <img [src]="preview" alt="Proof photo" class="w-full h-full object-cover">
            <button (click)="removePhoto(i)"
                    class="absolute top-1 right-1 w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center text-sm hover:bg-red-600 transition-colors">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <button *ngIf="photoPreviews.length < 3"
                  (click)="takePhoto()"
                  class="aspect-square border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:border-red-400 hover:text-red-400 transition-colors bg-gray-50">
            <i class="bi bi-camera text-3xl mb-2"></i>
            <span class="text-xs font-medium">إضافة صورة</span>
          </button>
        </div>
        <p class="text-xs text-gray-500">التقط صورة للموقع أو السبب</p>
      </div>

      <!-- Notes -->
      <div class="mb-6">
        <h3 class="font-semibold text-gray-800 mb-3">ملاحظات إضافية (اختياري)</h3>
        <textarea [(ngModel)]="notes"
                  placeholder="أضف أي تفاصيل إضافية..."
                  rows="3"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-red-400 focus:border-transparent resize-none">
        </textarea>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-3">
        <button (click)="cancel()"
                class="flex-1 py-3 px-4 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors">
          إلغاء
        </button>
        <button (click)="submitFailure()"
                [disabled]="isSubmitting || !selectedReason || photoPreviews.length === 0"
                class="flex-1 py-3 px-4 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl font-bold hover:shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed">
          <span *ngIf="isSubmitting" class="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent ml-2"></span>
          <span *ngIf="!isSubmitting">تأكيد الفشل</span>
          <span *ngIf="isSubmitting">جاري المعالجة...</span>
        </button>
      </div>
    </div>
  </div>
</div>