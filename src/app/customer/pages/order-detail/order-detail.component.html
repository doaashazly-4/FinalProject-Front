<div class="space-y-6" *ngIf="delivery && !isLoading">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <a routerLink="/customer/deliveries" class="inline-flex items-center gap-2 text-gray-500 hover:text-primary-green transition-colors mb-4">
        <i class="bi bi-arrow-right"></i>
        <span>العودة للشحنات</span>
      </a>
      <h1 class="text-2xl lg:text-3xl font-black text-primary-dark">{{ delivery.trackingNumber }}</h1>
      <p class="text-gray-600 mt-1">{{ delivery.description }}</p>
    </div>
    <span class="px-5 py-2 rounded-full text-sm font-bold"
          [ngClass]="getStatusClass(delivery.status)">
      {{ getStatusText(delivery.status) }}
    </span>
  </div>

  <!-- Real-time Map (if in transit) -->
  <div *ngIf="carrierLocation && ['in_transit', 'out_for_delivery', 'picked_up'].includes(delivery.status)"
       class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-5 border-b border-gray-100 bg-gradient-to-l from-blue-50 to-indigo-50">
      <h2 class="text-lg font-bold text-primary-dark flex items-center gap-2">
        <i class="bi bi-geo-alt text-blue-600"></i>
        موقع المندوب الآن
      </h2>
    </div>
    <div class="p-5">
      <div class="aspect-video bg-gray-100 rounded-xl mb-4 flex items-center justify-center relative overflow-hidden">
        <iframe *ngIf="mapUrl" 
                [src]="mapUrl" 
                class="w-full h-full border-0 rounded-xl"
                allowfullscreen>
        </iframe>
        <div *ngIf="!mapUrl" class="text-center text-gray-500">
          <i class="bi bi-map text-4xl mb-2"></i>
          <p>جاري تحميل الخريطة...</p>
        </div>
      </div>
      <p class="text-sm text-gray-600 text-center">
        <i class="bi bi-clock ml-1"></i>
        آخر تحديث: {{ formatDate(carrierLocation.timestamp) }}
      </p>
    </div>
  </div>

  <!-- Communication Actions -->
  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="p-5 border-b border-gray-100 bg-gray-50/50">
      <h2 class="text-lg font-bold text-primary-dark flex items-center gap-2">
        <i class="bi bi-chat-dots text-primary-green"></i>
        التواصل
      </h2>
    </div>
    <div class="p-5">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Call Carrier -->
        <button *ngIf="delivery.courierPhone"
                (click)="callCarrier()"
                class="flex items-center justify-center gap-3 p-4 bg-gradient-to-br from-primary-green to-secondary-teal text-white rounded-xl font-bold hover:shadow-green-lg transition-all">
          <i class="bi bi-telephone-fill text-xl"></i>
          <span>اتصال بالمندوب</span>
        </button>

        <!-- Call Supplier -->
        <button *ngIf="delivery.senderPhone"
                (click)="callSupplier()"
                class="flex items-center justify-center gap-3 p-4 bg-blue-100 text-blue-700 rounded-xl font-bold hover:bg-blue-200 transition-colors">
          <i class="bi bi-telephone text-xl"></i>
          <span>اتصال بالمُرسل</span>
        </button>

        <!-- Update Notes -->
        <button (click)="showNoteModal = true"
                class="flex items-center justify-center gap-3 p-4 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200 transition-colors">
          <i class="bi bi-pencil text-xl"></i>
          <span>تحديث الملاحظات</span>
        </button>

        <!-- Change Time -->
        <button *ngIf="delivery.status !== 'delivered'"
                (click)="showTimeChangeModal = true"
                class="flex items-center justify-center gap-3 p-4 bg-orange-100 text-orange-700 rounded-xl font-bold hover:bg-orange-200 transition-colors">
          <i class="bi bi-clock text-xl"></i>
          <span>تغيير الوقت</span>
        </button>

        <!-- Not Available Today -->
        <button *ngIf="delivery.status !== 'delivered'"
                (click)="markNotAvailableToday()"
                class="flex items-center justify-center gap-3 p-4 bg-red-100 text-red-700 rounded-xl font-bold hover:bg-red-200 transition-colors">
          <i class="bi bi-x-circle text-xl"></i>
          <span>غير متاح اليوم</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Delivery Info Cards -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Sender Info -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50/50">
        <h3 class="font-bold text-primary-dark flex items-center gap-2">
          <i class="bi bi-person text-primary-green"></i>
          المُرسل
        </h3>
      </div>
      <div class="p-4">
        <p class="font-bold text-primary-dark">{{ delivery.senderName }}</p>
        <p *ngIf="delivery.senderPhone" class="text-sm text-gray-500 mt-1">{{ delivery.senderPhone }}</p>
      </div>
    </div>

    <!-- Delivery Address -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50/50">
        <h3 class="font-bold text-primary-dark flex items-center gap-2">
          <i class="bi bi-geo-alt text-primary-green"></i>
          عنوان التسليم
        </h3>
      </div>
      <div class="p-4">
        <p class="font-medium text-primary-dark">{{ delivery.deliveryAddress }}</p>
        <p *ngIf="delivery.notes" class="text-sm text-gray-600 mt-2 p-2 bg-gray-50 rounded-lg">
          <i class="bi bi-info-circle ml-1"></i>
          {{ delivery.notes }}
        </p>
      </div>
    </div>

    <!-- Courier Info -->
    <div *ngIf="delivery.courierName" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-blue-50">
        <h3 class="font-bold text-blue-800 flex items-center gap-2">
          <i class="bi bi-truck text-blue-600"></i>
          المندوب
        </h3>
      </div>
      <div class="p-4">
        <p class="font-bold text-primary-dark">{{ delivery.courierName }}</p>
        <p *ngIf="delivery.courierPhone" class="text-sm text-gray-500 mt-1">{{ delivery.courierPhone }}</p>
      </div>
    </div>

    <!-- Delivery Details -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
      <div class="p-4 border-b border-gray-100 bg-gray-50/50">
        <h3 class="font-bold text-primary-dark flex items-center gap-2">
          <i class="bi bi-info-circle text-primary-green"></i>
          التفاصيل
        </h3>
      </div>
      <div class="p-4 space-y-2">
        <div class="flex justify-between">
          <span class="text-gray-500 text-sm">الوزن:</span>
          <span class="font-medium">{{ delivery.weight }} كجم</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 text-sm">تاريخ الإنشاء:</span>
          <span class="font-medium">{{ formatDate(delivery.createdAt) }}</span>
        </div>
        <div *ngIf="delivery.estimatedDelivery" class="flex justify-between">
          <span class="text-gray-500 text-sm">التوصيل المتوقع:</span>
          <span class="font-medium text-primary-green">{{ formatDate(delivery.estimatedDelivery) }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="flex justify-center items-center py-20">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-primary-green border-t-transparent mx-auto mb-4"></div>
    <p class="text-gray-500">جاري تحميل تفاصيل الشحنة...</p>
  </div>
</div>

<!-- Rating Modal -->
<div *ngIf="showRatingModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/50" (click)="showRatingModal = false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-2xl font-black text-primary-dark">قيم التوصيل</h2>
      <button (click)="showRatingModal = false" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <i class="bi bi-x text-gray-500 text-xl"></i>
      </button>
    </div>
    
    <div class="space-y-6">
      <!-- Stars -->
      <div class="flex justify-center gap-2">
        <button *ngFor="let i of [1,2,3,4,5]"
                (click)="setRating(i)"
                class="text-4xl transition-transform hover:scale-110"
                [ngClass]="i <= rating ? 'text-accent-gold' : 'text-gray-300'">
          <i class="bi" [ngClass]="i <= rating ? 'bi-star-fill' : 'bi-star'"></i>
        </button>
      </div>
      
      <!-- Comment -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">تعليق (اختياري)</label>
        <textarea [(ngModel)]="ratingComment"
                  rows="3"
                  placeholder="شاركنا تجربتك..."
                  class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary-green focus:ring-2 focus:ring-primary-green/20 outline-none resize-none"></textarea>
      </div>
      
      <!-- Submit -->
      <button (click)="submitRating()"
              [disabled]="rating === 0"
              class="w-full py-3 bg-gradient-to-br from-primary-green to-secondary-teal text-white font-bold rounded-xl hover:shadow-green-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
        إرسال التقييم
      </button>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div *ngIf="showNoteModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/50" (click)="showNoteModal = false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-primary-dark">تحديث الملاحظات</h2>
      <button (click)="showNoteModal = false" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <i class="bi bi-x text-gray-500 text-xl"></i>
      </button>
    </div>
    
    <div class="space-y-4">
      <textarea [(ngModel)]="deliveryNote"
                rows="4"
                placeholder="مثال: اترك الطرد عند الاستقبال"
                class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary-green focus:ring-2 focus:ring-primary-green/20 outline-none resize-none"></textarea>
      
      <div class="flex gap-3">
        <button (click)="showNoteModal = false"
                class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors">
          إلغاء
        </button>
        <button (click)="updateDeliveryNote()"
                class="flex-1 py-3 bg-gradient-to-br from-primary-green to-secondary-teal text-white rounded-xl font-bold hover:shadow-green-lg transition-all">
          حفظ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Time Change Modal -->
<div *ngIf="showTimeChangeModal" class="fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/50" (click)="showTimeChangeModal = false"></div>
  <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-bold text-primary-dark">تغيير وقت التسليم</h2>
      <button (click)="showTimeChangeModal = false" class="p-2 hover:bg-gray-100 rounded-full transition-colors">
        <i class="bi bi-x text-gray-500 text-xl"></i>
      </button>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">الوقت الجديد</label>
        <input type="datetime-local"
               [(ngModel)]="newTime"
               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary-green focus:ring-2 focus:ring-primary-green/20 outline-none">
      </div>
      
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">السبب (اختياري)</label>
        <textarea [(ngModel)]="timeChangeReason"
                  rows="2"
                  placeholder="اذكر سبب تغيير الوقت..."
                  class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-primary-green focus:ring-2 focus:ring-primary-green/20 outline-none resize-none"></textarea>
      </div>
      
      <div class="flex gap-3">
        <button (click)="showTimeChangeModal = false"
                class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors">
          إلغاء
        </button>
        <button (click)="requestTimeChange()"
                class="flex-1 py-3 bg-gradient-to-br from-primary-green to-secondary-teal text-white rounded-xl font-bold hover:shadow-green-lg transition-all">
          إرسال الطلب
        </button>
      </div>
    </div>
  </div>
</div>

